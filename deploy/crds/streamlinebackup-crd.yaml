apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: streamlinebackups.streamline.io
spec:
  group: streamline.io
  names:
    kind: StreamlineBackup
    listKind: StreamlineBackupList
    plural: streamlinebackups
    singular: streamlinebackup
    shortNames:
      - slbackup
      - slb
  scope: Namespaced
  versions:
    - name: v1beta1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - clusterRef
                - storage
              properties:
                clusterRef:
                  type: string
                  description: Reference to the StreamlineCluster to back up
                backupType:
                  type: string
                  enum: [Full, Incremental, MetadataOnly]
                  default: Full
                storage:
                  type: object
                  required:
                    - type
                  properties:
                    type:
                      type: string
                      enum: [S3, GCS, AzureBlob, PVC]
                    bucket:
                      type: string
                    endpoint:
                      type: string
                    prefix:
                      type: string
                    credentialsSecret:
                      type: string
                    region:
                      type: string
                    pvcName:
                      type: string
                schedule:
                  type: string
                  description: Cron expression for scheduled backups
                retentionCount:
                  type: integer
                  default: 5
                  minimum: 1
                topics:
                  type: array
                  items:
                    type: string
                includeOffsets:
                  type: boolean
                  default: true
                includeAcls:
                  type: boolean
                  default: true
                includeConfigs:
                  type: boolean
                  default: true
                compression:
                  type: string
                  default: zstd
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum: [Pending, Running, Completed, Failed, Expired]
                lastBackupTime:
                  type: string
                lastSuccessfulTime:
                  type: string
                completedBackups:
                  type: integer
                lastBackupSizeBytes:
                  type: integer
                lastBackupDurationSecs:
                  type: integer
                topicsBackedUp:
                  type: integer
                error:
                  type: string
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      conditionType:
                        type: string
                      status:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Cluster
          type: string
          jsonPath: .spec.clusterRef
        - name: Type
          type: string
          jsonPath: .spec.backupType
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Schedule
          type: string
          jsonPath: .spec.schedule
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
